# calico

每个节点都要提前安装下 [cni-plugins](https://github.com/containernetworking/plugins/releases)

## 安装

给一个搭建完 K8S 没部署 CNI 的集群安装的话，官方文档有两种安装方式 `Opertator|Manifest`，见官方文档 [kubernetes/quickstart](https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart) 的 [Step 2. Install Calico](https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart#step-2-install-calico)

这里以使用 `Opertator` 举例，实际的 yml 链接以官方文档里为准：

```shell
# 先部署 operator，由于镜像是外国的，所以 sed 替换下
URL=https://raw.githubusercontent.com/projectcalico/calico/v3.30.3/manifests/tigera-operator.yaml
wget $URL
sed -ri 's#(:\s*)(quay.io)#\1m.daocloud.io/\2#' tigera-operator.yaml
kubectl create -f tigera-operator.yaml
```

opreator 会使用 API 创建 calico 的相关 CRD，calico 的安装是要创建相关 CRD 资源的，我们先下载下来：

```shell
INSTALL_URL=https://raw.githubusercontent.com/projectcalico/calico/v3.30.3/manifests/custom-resources.yaml
wget $INSTALL_URL
vi custom-resources.yaml
```

主要是修改 `kind: Installation` 下面的属性，可以先看下注释里链接文档，说明了字段和含义

```yaml
# 可以先看下下面链接文档，说明了字段和含义
# For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.Installation
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec: # https://docs.tigera.io/calico/latest/reference/installation/api#installationspec
  calicoNetwork: # https://docs.tigera.io/calico/latest/reference/installation/api#caliconetworkspec
    ipPools:
    - name: default-ipv4-ippool
      blockSize: 24 # node 上分配到的 PodIP 的掩码，默认26，我喜欢改成24方便阅读
      cidr: 10.244.0.0/16 # Pod 的网段，如果和局域网冲突就要修改下，例如 kubeadm 的是 10.244.0.0/16
      encapsulation: VXLANCrossSubnet # https://docs.tigera.io/calico/latest/reference/installation/api#encapsulationtype
      natOutgoing: Enabled
      nodeSelector: all()
    nodeAddressAutodetectionV4: # https://docs.tigera.io/calico/latest/reference/installation/api#nodeaddressautodetection
      # 多网卡的时候选择使用哪张网卡的 IP 
      canReach: 223.5.5.5
  registry: m.daocloud.io/quay.io # https://docs.tigera.io/calico/latest/operations/image-options/alternate-registry
  # 下面这样不是理想的 xx/calico-xxx 而是 xxx///calico-xxx
  #imagePath: ""
  # imagePrefix: calico-
  # 设置为None 不安装 CSI 相关
  flexVolumePath: None
  kubeletVolumePluginPath: None
```

上面注释啥的都要看下和根据情况修改下，网络模式使用的 vxlan 模式，`VXLANCrossSubnet` 是同子网的 Node Pod不 vxlan 封装，等同于 flannel vxlan 下配置 `"Directrouting": true`。

```shell
kubectl apply -f custom-resources.yaml
```

查看状态：

```shell
$ kubectl get tigerastatus
NAME        AVAILABLE   PROGRESSING   DEGRADED   SINCE
apiserver   True        False         False      3m19s
calico      True        False         False      49s
goldmane    True        False         False      39s
ippools     True        False         False      119m
whisker     True        False         False      64s
```

## TODO 日后填坑

## 原理

## BGP

## 路由反射打通办公网到集群网络

## 链接

- [CNI flannel](04.06.md)
- 下一部分: [DNS](04.08.md)
